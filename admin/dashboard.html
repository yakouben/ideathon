<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - HAMIDATOU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#063666',
                        secondary: '#774411',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="flex h-screen">
        <!-- Mobile Header (visible on small screens) -->
        <header class="lg:hidden fixed top-0 left-0 right-0 bg-white shadow-sm z-50 px-4 py-3">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-bold text-primary">HAMIDATOU</h1>
                <div class="flex items-center space-x-2">
                    <button onclick="showSection('products')" 
                            class="p-2 rounded-lg hover:bg-gray-100 text-gray-700">
                        <i class="fas fa-box"></i>
                    </button>
                    <button onclick="showSection('orders')" 
                            class="p-2 rounded-lg hover:bg-gray-100 text-gray-700">
                        <i class="fas fa-shopping-cart"></i>
                    </button>
                    <button onclick="handleLogout()" class="p-2 rounded-lg hover:bg-gray-100 text-red-600">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Sidebar (hidden on small screens) -->
        <aside class="hidden lg:block w-64 bg-white shadow-lg fixed h-full">
            <div class="p-4 border-b">
                <h1 class="text-2xl font-bold text-primary">HAMIDATOU</h1>
                <p class="text-sm text-gray-600">Admin Dashboard</p>
            </div>
            <nav class="p-4">
                <ul class="space-y-2">
                    <li>
                        <button onclick="showSection('products')" 
                                class="w-full flex items-center space-x-3 text-gray-700 p-2 rounded-lg hover:bg-primary/5 hover:text-primary">
                            <i class="fas fa-box w-5"></i>
                            <span>Products</span>
                        </button>
                    </li>
                    <li>
                        <button onclick="showSection('orders')" 
                                class="w-full flex items-center space-x-3 text-gray-700 p-2 rounded-lg hover:bg-primary/5 hover:text-primary">
                            <i class="fas fa-shopping-cart w-5"></i>
                            <span>Orders</span>
                        </button>
                    </li>
                    <li>
                        <button onclick="handleLogout()" class="w-full flex items-center space-x-3 text-red-600 p-2 rounded-lg hover:bg-red-50">
                            <i class="fas fa-sign-out-alt w-5"></i>
                            <span>Log Out</span>
                        </button>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content (adjust margin for mobile) -->
        <main class="lg:ml-64 p-8 mt-16 lg:mt-0">
            <!-- Products Section -->
            <section id="products-section" class="space-y-6 ">
                <header class="flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-gray-800 px-6 ">Products Management</h2>
                    <button onclick="openAddProductModal()" 
                            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fas fa-plus mr-2 "></i>Add Product
                    </button>
                </header>

                <!-- Products Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 text-left text-sm font-medium text-gray-600">Produit</th>
                                <th class="p-4 text-left text-sm font-medium text-gray-600">Catégorie</th>
                                <th class="p-4 text-left text-sm font-medium text-gray-600">Prix</th>
                                <th class="p-4 text-left text-sm font-medium text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Orders Section -->
            <section id="orders-section" class="hidden">
                <header class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Gestion des Commandes</h2>
                </header>

                <!-- Orders Grid -->
                <div id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Orders will be loaded here -->
                </div>
            </section>
        </main>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-auto flex flex-col max-h-[90vh]">
                <div class="p-6">
                    <!-- Header -->
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">Ajouter un produit</h2>
                        <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Scrollable Form Container -->
                    <div class="overflow-y-auto pr-2" style="max-height: calc(90vh - 180px);">
                        <!-- Form -->
                        <form id="addProductForm" class="space-y-6" onsubmit="handleAddSubmit(event)">
                            <!-- Product Name -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nom du produit</label>
                                <input type="text" name="name" required
                                       class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors">
                            </div>

                            <!-- Category -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Catégorie</label>
                                <select name="category" required
                                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors">
                                    <option value="">Sélectionner une catégorie</option>
                                    <option value="parfum">Parfum</option>
                                    <option value="cosmetics">Cosmetics</option>
                                    <option value="maquillage">Maquillage</option>
                                    <option value="autres">Autres produits</option>
                                </select>
                            </div>

                            <!-- Description -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea name="description" rows="3" required
                                          class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors resize-none"></textarea>
                            </div>

                            <!-- Price -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Prix (DA)</label>
                                <div class="relative">
                                    <input type="number" name="price" required min="0"
                                           class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-colors">
                                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500">DA</span>
                                </div>
                            </div>

                            <!-- Image Upload -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Image du produit</label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-xl hover:border-primary/50 transition-colors relative">
                                    <div class="space-y-2 text-center">
                                        <div class="mx-auto h-24 w-24 image-preview flex items-center justify-center">
                                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                                        </div>
                                        <div class="flex text-sm text-gray-600">
                                            <label class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary/80">
                                                <span>Upload a file</span>
                                                <input type="file" 
                                                       accept="image/*"
                                                       class="sr-only"
                                                       onchange="handleFileUpload(event)">
                                            </label>
                                            <p class="pl-1">or drag and drop</p>
                                        </div>
                                        <p class="text-xs text-gray-500">PNG, JPG up to 2MB</p>
                                    </div>
                                    <input type="hidden" id="imageUrl" name="image_url">
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Fixed Bottom Buttons -->
                    <div class="pt-6 mt-6 border-t border-gray-100">
                        <div class="flex justify-end gap-3">
                            <button type="button" onclick="closeAddModal()"
                                    class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-colors">
                                Annuler
                            </button>
                            <button type="submit" form="addProductForm"
                                    class="px-6 py-2.5 bg-primary text-white rounded-xl hover:bg-primary/90 transition-colors">
                                Ajouter le produit
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Order Details Modal -->
    <div id="orderDetailsModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl mx-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Détails de la commande</h2>
                        <button onclick="closeOrderDetails()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="orderDetailsContent" class="space-y-6">
                        <!-- Order details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Update the Edit Product Modal -->
    <div id="editProductModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="relative min-h-screen flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Modifier le produit</h2>
                        <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <form id="editProductForm" class="space-y-4" onsubmit="handleEditSubmit(event)">
                        <input type="hidden" id="editProductId">
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nom du produit</label>
                            <input type="text" id="editName" required
                                   class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-primary">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Catégorie</label>
                            <select id="editCategory" required
                                    class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-primary">
                                <option value="parfum">Parfum</option>
                                <option value="cosmetics">Cosmetics</option>
                                <option value="maquillage">Maquillage</option>
                                <option value="autres">Autres produits</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Prix</label>
                            <input type="number" id="editPrice" required
                                   class="w-full px-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:border-primary">
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button type="button" onclick="closeEditModal()"
                                    class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">
                                Annuler
                            </button>
                            <button type="submit"
                                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                                Enregistrer
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Add these styles for better form interactions */
        input:focus::placeholder,
        textarea:focus::placeholder {
            color: #066620;
            opacity: 0.5;
        }

        .border-dashed:hover i {
            color: #066620;
            transform: scale(1.1);
            transition: all 0.3s ease;
        }

        /* File upload preview */
        .file-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 0.75rem;
        }

        /* Custom scrollbar for textarea */
        textarea {
            scrollbar-width: thin;
            scrollbar-color: #066620 transparent;
        }

        textarea::-webkit-scrollbar {
            width: 4px;
        }

        textarea::-webkit-scrollbar-track {
            background: transparent;
        }

        textarea::-webkit-scrollbar-thumb {
            background-color: #066620;
            border-radius: 4px;
        }

        /* Smooth scrollbar for form */
        .overflow-y-auto {
            scrollbar-width: thin;
            scrollbar-color: rgba(6, 102, 32, 0.3) transparent;
        }

        .overflow-y-auto::-webkit-scrollbar {
            width: 4px;
        }

        .overflow-y-auto::-webkit-scrollbar-track {
            background: transparent;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: rgba(6, 102, 32, 0.3);
            border-radius: 4px;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background-color: rgba(6, 102, 32, 0.5);
        }
    </style>

    <script>
        // Initialize Supabase client first
        const supabase = window.supabase.createClient(
            'https://oaexeiprmaxjyyowoein.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9hZXhlaXBybWF4anl5b3dvZWluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMxNzU3MjMsImV4cCI6MjA1ODc1MTcyM30.MYXRBEZc53AEVeFB512T7I1KqGVCGR74CCZctAaElEo'
        )

        // Check authentication
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession()
            if (!session) {
                window.location.href = '/admin/login.html'
                return
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                // Redirect to index.html
                window.location.href = '../index.html';
            } catch (error) {
                console.error('Error logging out:', error);
                alert('Failed to log out. Please try again.');
            }
        }

        // Check auth on page load
        checkAuth()

        // Add click handler to logout button
        document.querySelector('button.text-red-600').onclick = handleLogout

        // Define functions globally
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            const selectedSection = document.getElementById(`${sectionId}-section`);
            if (selectedSection) {
                selectedSection.classList.remove('hidden');
                if (sectionId === 'orders') {
                    loadOrders(); // Load orders when showing orders section
                }
            }
        }

        function openAddProductModal() {
            document.getElementById('addProductModal').classList.remove('hidden');
        }

        function closeAddModal() {
            document.getElementById('addProductModal').classList.add('hidden');
        }

        function handleImagePreview(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.querySelector('#imagePreview img').src = e.target.result;
                    document.querySelector('#imagePreview').classList.remove('hidden');
                    document.querySelector('#uploadIcon').classList.add('hidden');
                }
                reader.readAsDataURL(file);
            }
        }

        // Add this function to handle file upload
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show loading state
            const previewContainer = document.querySelector('.image-preview');
            previewContainer.innerHTML = `
                <div class="animate-pulse text-primary">
                    <i class="fas fa-spinner fa-spin text-4xl"></i>
                </div>
            `;

            try {
                // Compress image before upload
                const compressedFile = await compressImage(file);

                // Create a unique file name
                const fileName = `${Date.now()}-${file.name}`;
                
                // Upload to Supabase Storage
                const { data, error } = await supabase.storage
                    .from('products')
                    .upload(fileName, compressedFile, {
                        contentType: 'image/jpeg',
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    console.error('Upload error:', error);
                    throw new Error(`Upload failed: ${error.message}`);
                }

                // Get the public URL
                const { data: { publicUrl } } = supabase.storage
                    .from('products')
                    .getPublicUrl(fileName);

                // Show preview
                previewContainer.innerHTML = `
                    <img src="${publicUrl}" 
                         alt="Product preview" 
                         class="w-full h-full object-cover rounded-lg">
                `;

                // Store the URL for form submission
                document.getElementById('imageUrl').value = publicUrl;

            } catch (error) {
                console.error('Error uploading image:', error);
                alert(`Failed to upload image: ${error.message}`);
                // Reset preview on error
                previewContainer.innerHTML = `
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                `;
            }
        }

        // Add compression function
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Set width and height maintaining aspect ratio
                        let width = img.width;
                        let height = img.height;
                        
                        // Maximum dimension
                        const maxDim = 800;
                        if (width > height) {
                            if (width > maxDim) {
                                height = Math.round((height * maxDim) / width);
                                width = maxDim;
                            }
                        } else {
                            if (height > maxDim) {
                                width = Math.round((width * maxDim) / height);
                                height = maxDim;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Draw and compress
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to Blob with compression
                        canvas.toBlob(
                            (blob) => {
                                resolve(blob);
                            },
                            'image/jpeg',
                            0.7  // Compression quality (0.7 = 70% quality)
                        );
                    };
                };
            });
        }

        // Load and display products
        async function loadProducts() {
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Get the tbody element
                const tbody = document.querySelector('#products-section tbody');
                
                // Clear existing products
                tbody.innerHTML = '';
                
                // Add products to table
                products.forEach(product => {
                    tbody.innerHTML += `
                        <tr class="text-gray-600">
                            <td class="p-4">
                                <div class="flex items-center space-x-3">
                                    <img src="${product.image_url || '../assets/pro1.jpg'}" 
                                         alt="${product.name}" 
                                         class="w-12 h-12 rounded-lg object-cover">
                                    <div>
                                        <p class="font-medium text-gray-800">${product.name}</p>
                                    </div>
                                </div>
                            </td>
                            <td class="p-4">${product.category}</td>
                            <td class="p-4">${product.price.toLocaleString()} DA</td>
                            <td class="p-4">
                                <div class="flex space-x-2">
                                    <button onclick="editProduct('${product.id}')" 
                                            class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteProduct('${product.id}')" 
                                            class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });

            } catch (error) {
                console.error('Error loading products:', error);
                alert('Failed to load products. Please try again.');
            }
        }

        // Delete product function
        async function deleteProduct(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;

            try {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                // Reload products after deletion
                loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                alert('Failed to delete product. Please try again.');
            }
        }

        // Function to open edit modal with product data
        async function editProduct(id) {
            try {
                const { data: product, error } = await supabase
                    .from('products')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                // Populate form fields
                document.getElementById('editProductId').value = product.id;
                document.getElementById('editName').value = product.name;
                document.getElementById('editCategory').value = product.category;
                document.getElementById('editPrice').value = product.price;

                // Show modal
                document.getElementById('editProductModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading product:', error);
                alert('Failed to load product details');
            }
        }

        // Function to handle edit form submission
        async function handleEditSubmit(event) {
            event.preventDefault();

            const id = document.getElementById('editProductId').value;
            const updates = {
                name: document.getElementById('editName').value,
                category: document.getElementById('editCategory').value,
                price: parseFloat(document.getElementById('editPrice').value)
            };

            try {
                const { error } = await supabase
                    .from('products')
                    .update(updates)
                    .eq('id', id);

                if (error) throw error;

                closeEditModal();
                loadProducts(); // Refresh products list
                alert('Product updated successfully');
            } catch (error) {
                console.error('Error updating product:', error);
                alert('Failed to update product');
            }
        }

        // Function to close edit modal
        function closeEditModal() {
            document.getElementById('editProductModal').classList.add('hidden');
            document.getElementById('editProductForm').reset();
        }

        // Initialize everything else when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Show products section by default
            showSection('products');
            loadProducts();
        });

        // Add this function to handle new product submission
        async function handleAddSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Get values from form
            const product = {
                name: formData.get('name'),
                category: formData.get('category'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                image_url: document.getElementById('imageUrl').value
            };
            
            try {
                // Validate image
                if (!product.image_url) {
                    throw new Error('Please upload a product image');
                }
                
                // Insert into Supabase
                const { data, error } = await supabase
                    .from('products')
                    .insert([product]);
                
                if (error) throw error;
                
                // Success
                form.reset();
                closeAddModal();
                loadProducts(); // Refresh products list
                
                // Reset image preview
                const previewContainer = document.querySelector('.image-preview');
                previewContainer.innerHTML = `
                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400"></i>
                `;
                
                // Close the modal
                const modal = document.getElementById('addProductModal');
                modal.classList.add('hidden');
                
                // Show a non-blocking success message
                const successMessage = document.createElement('div');
                successMessage.className = 'fixed top-4 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                successMessage.textContent = 'Produit ajouté avec succès!';
                document.body.appendChild(successMessage);
                
                // Remove the success message after 3 seconds
                setTimeout(() => {
                    successMessage.remove();
                }, 3000);
                
            } catch (error) {
                console.error('Error adding product:', error);
                alert(error.message || 'Failed to add product. Please try again.');
            }
        }

        // Update the loadOrders function
        async function loadOrders() {
            try {
                console.log('Loading orders...');
                
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*')
                    .order('order_date', { ascending: false });

                if (error) throw error;

                const ordersGrid = document.getElementById('orders-grid');
                
                if (!orders || orders.length === 0) {
                    ordersGrid.innerHTML = `
                        <div class="col-span-full text-center py-8 text-gray-500">
                            <i class="fas fa-box-open text-4xl mb-3"></i>
                            <p>Aucune commande trouvée</p>
                        </div>
                    `;
                    return;
                }

                ordersGrid.innerHTML = orders.map(order => `
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden">
                        <!-- Header Section with Status -->
                        <div class="p-6 border-b border-gray-100">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-800">${order.customer_name}</h3>
                                    <p class="text-sm text-gray-500 flex items-center gap-2">
                                        <i class="fas fa-phone text-primary/60"></i>
                                        ${order.phone_number}
                                    </p>
                                </div>
                                <div class="flex gap-2">
                                    <select onchange="updateOrderStatus('${order.id}', this.value)" 
                                            class="text-sm px-4 py-1.5 rounded-full font-medium transition-colors ${
                                                order.status === 'completed' ? 'bg-blue-100 text-blue-800' :
                                                order.status === 'cancelled' ? 'bg-red-100 text-red-800' :
                                                'bg-yellow-100 text-yellow-800'
                                            }">
                                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>En attente</option>
                                        <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Complété</option>
                                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Annulé</option>
                                    </select>
                                    <button onclick="deleteOrder('${order.id}')" 
                                            class="text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-50 transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Delivery Info -->
                            <div class="mt-4 grid grid-cols-2 gap-4">
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-sm text-gray-600 flex items-center gap-2">
                                        <i class="fas fa-map-marker-alt text-primary"></i>
                                        <span class="font-medium">Adresse</span>
                                    </p>
                                    <p class="text-sm mt-1">${order.address}</p>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="text-sm text-gray-600 flex items-center gap-2">
                                        <i class="fas fa-truck text-primary"></i>
                                        <span class="font-medium">Livraison</span>
                                    </p>
                                    <p class="text-sm mt-1">${order.delivery_type === 'home' ? 'À domicile' : 'Point relais'}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Products Section -->
                        <div class="p-6 bg-gray-50">
                            <h4 class="text-sm font-medium mb-3 text-gray-700">Produits commandés</h4>
                            <div class="space-y-2">
                                ${order.order_items.map(item => `
                                    <div class="flex justify-between items-center text-sm bg-white p-2 rounded-lg">
                                        <div class="flex items-center gap-2">
                                            <img src="${item.image}" alt="${item.name}" 
                                                 class="w-10 h-10 rounded-lg object-cover shadow-sm">
                                            <span>${item.name}</span>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <span class="text-gray-500 bg-gray-100 px-2 py-1 rounded-full">×${item.quantity}</span>
                                            <span class="font-medium">${(item.price * item.quantity).toLocaleString()} DA</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Footer with Total and Date -->
                        <div class="p-6 border-t border-gray-100 flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="text-sm text-gray-600">${new Date(order.order_date).toLocaleDateString()}</span>
                                <span class="text-xs text-gray-400">${new Date(order.order_date).toLocaleTimeString()}</span>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="text-xs text-gray-500">Total</span>
                                <span class="text-lg font-bold text-primary">${order.total_amount.toLocaleString()} DA</span>
                            </div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading orders:', error);
                alert('Failed to load orders. Please try again.');
            }
        }

        // Add function to update order status
        async function updateOrderStatus(orderId, newStatus) {
            try {
                const { error } = await supabase
                    .from('orders')
                    .update({ status: newStatus })
                    .eq('id', orderId);

                if (error) throw error;
                
                // Refresh orders list
                loadOrders();
            } catch (error) {
                console.error('Error updating order status:', error);
                alert('Failed to update order status. Please try again.');
            }
        }

        // Add function to delete order
        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order?')) return;
            
            try {
                const { error } = await supabase
                    .from('orders')
                    .delete()
                    .eq('id', orderId);

                if (error) throw error;
                
                // Refresh orders list
                loadOrders();
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Failed to delete order. Please try again.');
            }
        }

        // View order details
        async function viewOrderDetails(orderId) {
            try {
                const { data: order, error } = await supabase
                    .from('orders')
                    .select('*')
                    .eq('id', orderId)
                    .single();

                if (error) throw error;

                const modal = document.getElementById('orderDetailsModal');
                const content = document.getElementById('orderDetailsContent');

                content.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">Client</p>
                            <p class="font-medium">${order.customer_name}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Téléphone</p>
                            <p class="font-medium">${order.phone_number}</p>
                        </div>
                        <div class="col-span-2">
                            <p class="text-gray-600">Adresse</p>
                            <p class="font-medium">${order.address}</p>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4">
                        <h3 class="font-medium mb-3">Produits commandés</h3>
                        <div class="space-y-3">
                            ${order.order_items.map(item => `
                                <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-lg">
                                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded">
                                    <div class="flex-1">
                                        <h4 class="font-medium">${item.name}</h4>
                                        <div class="flex justify-between mt-1 text-sm">
                                            <span class="text-gray-600">Quantité: ${item.quantity}</span>
                                            <span class="font-medium">${(item.price * item.quantity).toLocaleString()} DA</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <div class="flex justify-between items-center">
                            <span class="font-medium">Total</span>
                            <span class="text-lg font-bold text-primary">${order.total_amount.toLocaleString()} DA</span>
                        </div>
                    </div>
                `;

                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';

            } catch (error) {
                console.error('Error loading order details:', error);
            }
        }

        // Close order details modal
        function closeOrderDetails() {
            const modal = document.getElementById('orderDetailsModal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Add click handler for orders tab
            document.querySelector('[onclick="showSection(\'orders\')"]').addEventListener('click', function() {
                showSection('orders');
            });

            // Load orders if we're starting on the orders section
            if (!document.getElementById('orders-section').classList.contains('hidden')) {
                loadOrders();
            }
        });

        // Add this after your Supabase initialization
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const { data, error } = await supabase
                    .from('orders')
                    .select('count');
                
                console.log('Supabase connection test:', { data, error });
                
                if (error) {
                    console.error('Supabase connection error:', error);
                }
            } catch (error) {
                console.error('Failed to connect to Supabase:', error);
            }
        });
    </script>
</body>
</html> 